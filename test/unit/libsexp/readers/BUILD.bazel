load("@rules_cc//cc:defs.bzl", "cc_library")

load("//:BUILD.bzl",
     "BASE_SRCS", "BASE_DEPS", "BASE_INCLUDE_PATHS",
     "BASE_COPTS", "BASE_DEFINES", "BASE_LINKOPTS")

load("//test:BUILD.bzl",
     "TEST_SRCS", "TEST_DEPS", "TEST_INCLUDE_PATHS",
     "TEST_COPTS", "TEST_DEFINES", "TEST_LINKOPTS",
     "TIMEOUT")

SRCS          = BASE_SRCS + TEST_SRCS
INCLUDE_PATHS = BASE_INCLUDE_PATHS + TEST_INCLUDE_PATHS
COPTS         = BASE_COPTS + TEST_COPTS + INCLUDE_PATHS
DEPS          = BASE_DEPS + TEST_DEPS
DEFINES       = BASE_DEFINES + TEST_DEFINES
LINKOPTS      = BASE_LINKOPTS + TEST_LINKOPTS

TAGS = ["sexp", "readers", "read-errrors"]

# exports_files(["case010.dune"])

filegroup(
    name = "data",
    data = glob(["*.dune", "*.expected"]),
    visibility = ["//visibility:public"]
)

# make test files in subdirs accessible from this pkg
# exports_files(glob(["case010/*"]))

################################################################
cc_test(
    name = "readers",
    linkstatic = True,
    srcs = ["readers_test.c",
            "//test/unit:common.c", "//test/unit:common.h",
            "//src:libs7.h"],
    local_defines = DEFINES,
    data = [
        "case010.dune", "case010.expected"
        # "//test/unit/libsexp/readers:data",
    ],
    deps = DEPS + [
        "//lib/libsexp:sexp_s7_archive",
    ],
    copts = COPTS + [
        "-Isrc",
        "-Idev",
        "-Itest/unit",
        "-I$(GENDIR)/lib/libtoml",
        "-I$(GENDIR)/external/libs7/lib/libtoml",
        # "-fno-pie"
    ],
    linkopts = LINKOPTS,
    timeout = TIMEOUT,
    tags = TAGS
)
