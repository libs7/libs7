load("@rules_cc//cc:defs.bzl", "cc_library")

load("//:BUILD.bzl",
     "BASE_SRCS", "BASE_DEPS", "BASE_INCLUDE_PATHS",
     "BASE_COPTS", "BASE_DEFINES", "BASE_LINKOPTS",
     "CWALK_VERSION")

load("//test:BUILD.bzl",
     "TEST_SRCS", "TEST_DEPS", "TEST_INCLUDE_PATHS",
     "TEST_COPTS", "TEST_DEFINES", "TEST_LINKOPTS",
     "TIMEOUT")

SRCS          = BASE_SRCS + select({
    "//config/clibs/link:shared?": [
        "//lib/libmustachios:libmustachios7_s7.c"],
    "//conditions:default": []
})

INCLUDE_PATHS = BASE_INCLUDE_PATHS + TEST_INCLUDE_PATHS + [
    "-Itest/unit",
    "-Itest/libmustachios",
    "-Itest/libmustachios/cjson",
    "-Itest/libmustachios/toml",
    "-Ilib/libmustachios",
    "-Iexternal/libs7/lib/libmustachios",
]

COPTS         = BASE_COPTS + TEST_COPTS + INCLUDE_PATHS

DEPS          = BASE_DEPS + TEST_DEPS + select({
    "//config/clibs/link:archive?": [
        # "//vendored/toml",
        "@toml_s7//src:toml_s7",
        # "//lib/libtoml:toml_s7_archive",
        "//lib/libmustachios:mustachios_s7_archive",
    ],
    "//conditions:default": []
})
DATA = [
    "//scm:srcs",
    "//scm/srfi:srcs",
    "//scm/s7:srcs"
]

DEFINES       = BASE_DEFINES + TEST_DEFINES
LINKOPTS      = BASE_LINKOPTS + TEST_LINKOPTS

################################################################
cc_binary(
    name = "mustachios",
    linkstatic = True,
    srcs = SRCS + ["mustachios_test_runner.c"],
    copts = COPTS + [
        "-Iexternal//cwalk~{}/include".format(CWALK_VERSION)
    ],
    local_defines = DEFINES,
    deps = DEPS + ["@cwalk//src:cwalk"],
    data = DATA + select({
        "//config/clibs/link:runtime?": [
            "//lib/libmustachios:mustachios_s7"
        ],
        "//conditions:default": []
    }),
    linkopts = LINKOPTS,
    visibility = ["//visibility:public"]
)
