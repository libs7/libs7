load("@rules_cc//cc:defs.bzl", "cc_library")

cc_test(
    name = "test",
    srcs = ["s7_test.c"],
    deps = [
        "//src:s7",
        "//vendored/gopt",
        "//vendored/logc",
        "//vendored/unity",
        "//vendored/uthash",
    ] + select({
        "//config/clibs/link:static?": [
            "//lib/static:c_s7",
            "//lib/static:dl_s7",
            "//lib/static:m_s7",
            "//lib/static:cwalk_s7",
        ],
        "//conditions:default": [
            # "//lib/shared:c_s7",
            # "//lib/shared:dl_s7",
            # "//lib/shared:m_s7",
            # "//lib/shared:cwalk_s7",

            # "//lib/static:c_s7_shared",
            # "//lib/static:dl_s7_shared",
            # "//lib/static:m_s7_shared",
            # "//lib/static:cwalk_s7_shared",
        ]
    }),
    data = [
        "//lib/shared:c_s7",
        "//lib/shared:dl_s7",
        "//lib/shared:m_s7",
        "//lib/shared:cwalk_s7",
    ],
    copts = [
        "-Wall",
        "-Wextra",
        "-Werror=pedantic",
        "-Wno-unused-parameter",
        "-Wno-format-pedantic",

        "-Isrc",
        "-Iexternal/libs7/src",

        "-I$(GENDIR)/lib",
        "-I$(GENDIR)/external/libs7/lib",

        "-Ivendored/gopt",
        "-Iexternal/libs7/vendored/gopt",

        "-Ivendored/logc",
        "-Iexternal/libs7/vendored/logc",

        "-Ivendored/unity",
        "-Iexternal/libs7/vendored/unity",

        "-Ivendored/uthash",
        "-Iexternal/libs7/vendored/uthash",
    ] + select({
        "//:macos": [
            "-Wno-gnu",
            "-std=c11"
        ],
        "//:linux": [
            "-std=gnu11",
            "--pedantic-errors",
        ],
        "//conditions:default": ["-std=c11"],
    }),
    defines = select({
        "//config/host:debug": ["DEBUG_TRACE"],
        "//conditions:default":   []
    }) + select({
        "//config/clibs/link:static?": ["CLIBS_LINK_STATIC"],
        "//conditions:default":   []
    }) + select({
        "//config/host:macos": ["DSO_EXT=\\\".dylib\\\""],
        "//config/host:linux": [
            "DSO_EXT=\\\".so\\\"",
            "_XOPEN_SOURCE=500", # strdup
            "_DEFAULT_SOURCE"    # dirent DT_* macros
        ],
        "//conditions:default":   ["DSO_EXT=\\\".so\\\""]
    }),
    linkopts = select({
        # "//:macos": ["-ldl"],
        "//:linux": ["-rdynamic"],
        "//conditions:default": []
    }),
    timeout = "short",
    visibility = ["//test:__subpackages__"]
)
